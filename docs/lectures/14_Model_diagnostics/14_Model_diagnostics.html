<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nicky Wakim">
<meta name="dcterms.date" content="2024-05-20">

<title>Lesson 14: Model Diagnostics ‚Äì Categorical Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-62d5ecfa613c5c5644cabfb02a2f4c65.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-sm " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/Bsta513.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Categorical Data Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../schedule.html"> 
<span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../instructors.html"> 
<span class="menu-text">Instructors</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../homeworks.html"> 
<span class="menu-text">Homework</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../project.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning Objectives</a>
  <ul class="collapse">
  <li><a href="#review-of-model-assessment-so-far-12" id="toc-review-of-model-assessment-so-far-12" class="nav-link" data-scroll-target="#review-of-model-assessment-so-far-12">Review of model assessment so far (1/2)</a></li>
  <li><a href="#review-of-model-assessment-so-far-22" id="toc-review-of-model-assessment-so-far-22" class="nav-link" data-scroll-target="#review-of-model-assessment-so-far-22">Review of model assessment so far (2/2)</a></li>
  <li><a href="#today" id="toc-today" class="nav-link" data-scroll-target="#today">Today</a></li>
  </ul></li>
  <li><a href="#learning-objectives-1" id="toc-learning-objectives-1" class="nav-link" data-scroll-target="#learning-objectives-1">Learning Objectives</a>
  <ul class="collapse">
  <li><a href="#review-of-number-of-covariate-patterns" id="toc-review-of-number-of-covariate-patterns" class="nav-link" data-scroll-target="#review-of-number-of-covariate-patterns">Review of Number of Covariate Patterns</a></li>
  <li><a href="#from-overall-measure-to-diagnostics" id="toc-from-overall-measure-to-diagnostics" class="nav-link" data-scroll-target="#from-overall-measure-to-diagnostics">From overall measure to diagnostics</a></li>
  <li><a href="#hat-matrix-and-leverage-values-linear-regression" id="toc-hat-matrix-and-leverage-values-linear-regression" class="nav-link" data-scroll-target="#hat-matrix-and-leverage-values-linear-regression">Hat Matrix and Leverage Values: Linear regression</a></li>
  <li><a href="#hat-matrix-and-leverage-values-logistic-regression" id="toc-hat-matrix-and-leverage-values-logistic-regression" class="nav-link" data-scroll-target="#hat-matrix-and-leverage-values-logistic-regression">Hat Matrix and Leverage Values: Logistic regression</a></li>
  <li><a href="#poll-everywhere-question-1" id="toc-poll-everywhere-question-1" class="nav-link" data-scroll-target="#poll-everywhere-question-1">Poll Everywhere Question 1</a></li>
  <li><a href="#poll-everywhere-question-2" id="toc-poll-everywhere-question-2" class="nav-link" data-scroll-target="#poll-everywhere-question-2">Poll Everywhere Question 2</a></li>
  <li><a href="#diagnostic-statistics-computation-12" id="toc-diagnostic-statistics-computation-12" class="nav-link" data-scroll-target="#diagnostic-statistics-computation-12">Diagnostic Statistics Computation (1/2)</a></li>
  <li><a href="#diagnostic-statistics-computation-22" id="toc-diagnostic-statistics-computation-22" class="nav-link" data-scroll-target="#diagnostic-statistics-computation-22">Diagnostic Statistics Computation (2/2)</a></li>
  <li><a href="#diagnostics-of-logistic-regression" id="toc-diagnostics-of-logistic-regression" class="nav-link" data-scroll-target="#diagnostics-of-logistic-regression">Diagnostics of Logistic Regression</a></li>
  <li><a href="#change-of-standardized-residuals" id="toc-change-of-standardized-residuals" class="nav-link" data-scroll-target="#change-of-standardized-residuals">Change of Standardized Residuals</a></li>
  <li><a href="#change-of-estimated-coefficients" id="toc-change-of-estimated-coefficients" class="nav-link" data-scroll-target="#change-of-estimated-coefficients">Change of Estimated Coefficients</a></li>
  </ul></li>
  <li><a href="#minute-break" id="toc-minute-break" class="nav-link" data-scroll-target="#minute-break">10 minute break</a></li>
  <li><a href="#learning-objectives-2" id="toc-learning-objectives-2" class="nav-link" data-scroll-target="#learning-objectives-2">Learning Objectives</a>
  <ul class="collapse">
  <li><a href="#visual-assessment-for-diagnostics-of-logistic-regression-i" id="toc-visual-assessment-for-diagnostics-of-logistic-regression-i" class="nav-link" data-scroll-target="#visual-assessment-for-diagnostics-of-logistic-regression-i">Visual Assessment for Diagnostics of Logistic Regression (I)</a></li>
  <li><a href="#recall-the-model-we-fit-glow-study-with-interactions" id="toc-recall-the-model-we-fit-glow-study-with-interactions" class="nav-link" data-scroll-target="#recall-the-model-we-fit-glow-study-with-interactions">Recall the model we fit: GLOW Study with interactions</a></li>
  <li><a href="#how-do-we-get-these-values-in-r" id="toc-how-do-we-get-these-values-in-r" class="nav-link" data-scroll-target="#how-do-we-get-these-values-in-r">How do we get these values in R?</a></li>
  <li><a href="#key-to-the-values" id="toc-key-to-the-values" class="nav-link" data-scroll-target="#key-to-the-values">Key to the values</a></li>
  <li><a href="#poll-everywhere-question-3" id="toc-poll-everywhere-question-3" class="nav-link" data-scroll-target="#poll-everywhere-question-3">Poll Everywhere Question 3</a></li>
  <li><a href="#visual-assessment-for-diagnostics-of-logistic-regression" id="toc-visual-assessment-for-diagnostics-of-logistic-regression" class="nav-link" data-scroll-target="#visual-assessment-for-diagnostics-of-logistic-regression">Visual Assessment for Diagnostics of Logistic Regression</a></li>
  <li><a href="#glow-study-standardized-pearson-residuals" id="toc-glow-study-standardized-pearson-residuals" class="nav-link" data-scroll-target="#glow-study-standardized-pearson-residuals">GLOW study: standardized Pearson residuals</a></li>
  <li><a href="#glow-study-standardized-pearson-residuals-1" id="toc-glow-study-standardized-pearson-residuals-1" class="nav-link" data-scroll-target="#glow-study-standardized-pearson-residuals-1">GLOW study: standardized Pearson residuals</a></li>
  <li><a href="#glow-study-standardized-pearson-residuals-2" id="toc-glow-study-standardized-pearson-residuals-2" class="nav-link" data-scroll-target="#glow-study-standardized-pearson-residuals-2">GLOW study: standardized Pearson residuals</a></li>
  <li><a href="#glow-study-standardized-deviance-residuals" id="toc-glow-study-standardized-deviance-residuals" class="nav-link" data-scroll-target="#glow-study-standardized-deviance-residuals">GLOW study: standardized Deviance residuals</a></li>
  <li><a href="#glow-study-change-in-coefficient-estimates" id="toc-glow-study-change-in-coefficient-estimates" class="nav-link" data-scroll-target="#glow-study-change-in-coefficient-estimates">GLOW Study: Change in coefficient estimates</a></li>
  <li><a href="#glow-study-leverage" id="toc-glow-study-leverage" class="nav-link" data-scroll-target="#glow-study-leverage">GLOW Study: Leverage</a></li>
  <li><a href="#find-out-the-influential-observation-from-the-data-set" id="toc-find-out-the-influential-observation-from-the-data-set" class="nav-link" data-scroll-target="#find-out-the-influential-observation-from-the-data-set">Find Out the ‚ÄúInfluential‚Äù Observation From the Data Set</a></li>
  <li><a href="#after-identifying-points" id="toc-after-identifying-points" class="nav-link" data-scroll-target="#after-identifying-points">After identifying points</a></li>
  <li><a href="#how-would-i-report-this-combining-all-model-assessment" id="toc-how-would-i-report-this-combining-all-model-assessment" class="nav-link" data-scroll-target="#how-would-i-report-this-combining-all-model-assessment">How would I report this? (Combining all model assessment)</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="14_Model_diagnostics.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lesson 14: Model Diagnostics</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Nicky Wakim </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 20, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>‚îÄ‚îÄ Attaching core tidyverse packages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse 2.0.0 ‚îÄ‚îÄ
‚úî dplyr     1.1.4     ‚úî readr     2.1.5
‚úî forcats   1.0.0     ‚úî stringr   1.5.1
‚úî ggplot2   3.5.1     ‚úî tibble    3.2.1
‚úî lubridate 1.9.3     ‚úî tidyr     1.3.1
‚úî purrr     1.0.2     
‚îÄ‚îÄ Conflicts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse_conflicts() ‚îÄ‚îÄ
‚úñ dplyr::filter() masks stats::filter()
‚úñ dplyr::lag()    masks stats::lag()
‚Ñπ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
here() starts at /Users/wakim/Library/CloudStorage/OneDrive-OregonHealth&amp;ScienceUniversity/Teaching/Classes/S25_BSTA_513/S25_BSTA_513_site</code></pre>
</div>
</div>
<section id="learning-objectives" class="level1">
<h1>Learning Objectives</h1>
<ol type="1">
<li><p>Understand the components of calculations for logistic regression diagnostics</p></li>
<li><p>Plot and determine observations where regression does not fit well or are influential using specific diagnostic values</p></li>
</ol>
<div class="cell">
<style type="text/css">
.reveal code {
  max-height: 80% !important;
}
</style>
</div>
<section id="review-of-model-assessment-so-far-12" class="level2">
<h2 class="anchored" data-anchor-id="review-of-model-assessment-so-far-12">Review of model assessment so far (1/2)</h2>
<ul>
<li><p>Overall measurements of fit</p>
<ul>
<li><p>How well does the fitted logistic regression model predict the outcome?</p></li>
<li><p>Different ways to measure the answer to this question</p></li>
</ul></li>
</ul>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 22%">
<col style="width: 33%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th>Measure of fit</th>
<th>Hypothesis tested?</th>
<th>Equation</th>
<th>R code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Pearson residual</td>
<td>Yes</td>
<td><span class="math inline">\(X^2=\sum_{j=1}^{J}{r\left(Y_j,{\hat{\pi}}_j\right)^2}\)</span></td>
<td>Not given</td>
</tr>
<tr class="even">
<td>Hosmer-Lemeshow test</td>
<td>Yes</td>
<td><span class="math inline">\(\hat{C}=\sum_{k=1}^{g}\frac{\left(o_k-n_k^\prime{\bar{\pi}}_k\right)^2}{n_k^\prime{\bar{\pi}}_k(1-{\bar{\pi}}_k)}\)</span></td>
<td><code>hoslem.test()</code></td>
</tr>
<tr class="odd">
<td>AUC-ROC</td>
<td>Kinda</td>
<td>Not given</td>
<td><code>auc(observed, predicted)</code></td>
</tr>
<tr class="even">
<td>AIC</td>
<td>Only to compare models</td>
<td><span class="math inline">\(AIC = -2 \cdot \text{log-likelihood} + 2q\)</span></td>
<td><code>AIC(model_name)</code></td>
</tr>
<tr class="odd">
<td>BIC</td>
<td>Only to compare models</td>
<td><span class="math inline">\(BIC = -2 \cdot \text{log-likelihood} + q\text{log}(n)\)</span></td>
<td><code>BIC(model_name)</code></td>
</tr>
</tbody>
</table>
</section>
<section id="review-of-model-assessment-so-far-22" class="level2">
<h2 class="anchored" data-anchor-id="review-of-model-assessment-so-far-22">Review of model assessment so far (2/2)</h2>
<ul>
<li><p>Numerical problems</p>
<ul>
<li>Assess pre and post model fit</li>
<li>Numerical problems often depend on the final model (which variables and interactions are included)</li>
</ul></li>
<li><p>Different numerical problems to look out for</p>
<ul>
<li>Zero cell count</li>
<li>Complete separation</li>
<li>Multicollinearity</li>
</ul></li>
</ul>
</section>
<section id="today" class="level2">
<h2 class="anchored" data-anchor-id="today">Today</h2>
<ul>
<li>We now use model diagnostics to identify any observations that the model does not fit well</li>
</ul>
</section>
</section>
<section id="learning-objectives-1" class="level1">
<h1>Learning Objectives</h1>
<div class="lob">
<ol type="1">
<li>Understand the components of calculations for logistic regression diagnostics</li>
</ol>
</div>
<ol start="2" type="1">
<li>Plot and determine observations where regression does not fit well or are influential using specific diagnostic values</li>
</ol>
<section id="review-of-number-of-covariate-patterns" class="level2">
<h2 class="anchored" data-anchor-id="review-of-number-of-covariate-patterns">Review of Number of Covariate Patterns</h2>
<ul>
<li>Covariate patterns are the <strong>unique covariate combinations</strong> that are observed</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p><strong>For example:</strong> model contains two binary covariates (history of fracture and smoking status), there will be <strong>4 unique combination of these factors</strong></p>
<ul>
<li>This model has <strong>4 covariate patterns</strong></li>
<li>Subjects can be divided into 4 groups based on the covariates‚Äô values</li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li>When we have <strong>continuous covariates</strong>, the number of covariate patterns will be close to the <strong>number of individuals in the dataset</strong></li>
</ul>
</section>
<section id="from-overall-measure-to-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="from-overall-measure-to-diagnostics">From overall measure to diagnostics</h2>
<ul>
<li><p>Now we need to investigate diagnostics looking at individual data or covariate pattern data</p>
<ul>
<li>Make sure the overall measure has not been influenced by certain observations</li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>The key quantities from logistic regression diagnostics are the components of ‚Äúresidual sum-of-squares‚Äù</p>
<ul>
<li><p>The same idea as in the linear regression</p></li>
<li><p>Assessed for <strong>each covariate pattern</strong> <span class="math inline">\(j\)</span>, by computing standardized Pearson residuals and Deviance residuals</p>
<ul>
<li>Standardization using <span class="math inline">\(h_j\)</span>, the leverage values</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="hat-matrix-and-leverage-values-linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="hat-matrix-and-leverage-values-linear-regression">Hat Matrix and Leverage Values: Linear regression</h2>
<ul>
<li>We have learned ‚Äúhat‚Äù matrix and leverage values from linear regression diagnostics</li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>In linear regression, the hat matrix projects the outcome variable onto the covariate space:</p>
<p>&nbsp;</p>
<ul>
<li><span class="math inline">\(H=X\left(X^\prime X\right)^{-1}X^\prime\)</span> and <span class="math inline">\(\hat{y}=Hy\)</span></li>
</ul>
<p>&nbsp;</p>
<ul>
<li>The linear regression residuals is thus <span class="math inline">\(y - \widehat{y}\)</span>, or <span class="math inline">\((I-H)y\)</span></li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li>The leverage is just the diagonal elements of the hat matrix, which is proportional to the distance of <span class="math inline">\(x_j\)</span> to the mean of the data <span class="math inline">\(\overline{x}\)</span></li>
</ul>
</section>
<section id="hat-matrix-and-leverage-values-logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="hat-matrix-and-leverage-values-logistic-regression">Hat Matrix and Leverage Values: Logistic regression</h2>
<ul>
<li><p>In logistic regression model, the hat matrix is: <span class="math display">\[H=V^\frac{1}{2}X\left(X^\prime V\ X\right)^{-1}X^\prime V^\frac{1}{2}\]</span></p></li>
<li><p>The leverage is <span class="math display">\[h_j=m_j\cdot\hat{\pi}\left(\textbf{x}_j\right)\left[1-\hat{\pi}\left(\textbf{x}_j\right)\right]\textbf{x}_j^\prime\left(\textbf{X}^\prime\textbf{VX}\right)^{-1}\textbf{x}_j=v_j\cdot b_j\]</span></p>
<ul>
<li><p><span class="math inline">\(b\)</span>: weighted distance of <span class="math inline">\(x_j\)</span> from <span class="math inline">\(\overline{x}\)</span></p></li>
<li><p><span class="math inline">\(v_j\)</span>: model based estimator of the variance of <span class="math inline">\(y_j\)</span></p>
<ul>
<li><span class="math inline">\(v_j=m_j\cdot\hat{\pi}\left(\textbf{x}_j\right)\left[1-\hat{\pi}\left(\textbf{x}_j\right)\right]\)</span></li>
</ul></li>
</ul></li>
<li><p><span class="math inline">\(h_j\)</span> <strong>reflects the relative influence of each covariate pattern on the model‚Äôs fit</strong></p></li>
</ul>
</section>
<section id="poll-everywhere-question-1" class="level2">
<h2 class="anchored" data-anchor-id="poll-everywhere-question-1">Poll Everywhere Question 1</h2>
</section>
<section id="poll-everywhere-question-2" class="level2">
<h2 class="anchored" data-anchor-id="poll-everywhere-question-2">Poll Everywhere Question 2</h2>
</section>
<section id="diagnostic-statistics-computation-12" class="level2">
<h2 class="anchored" data-anchor-id="diagnostic-statistics-computation-12">Diagnostic Statistics Computation (1/2)</h2>
<ul>
<li><p>Two diagnostic statistics computation approach</p>
<ul>
<li><p><strong>Approach 1</strong>: computed by covariate pattern</p>
<ul>
<li>Recommendation of Hosmer-Lemeshow textbook</li>
<li>R uses this approach</li>
<li>Identify outliers as group that shares the same covariate values (in the same covariate pattern)</li>
</ul></li>
<li><p><strong>Approach 2</strong>: individual observation approach</p>
<ul>
<li>SAS uses this approach</li>
<li>Identify outliers as individual</li>
</ul></li>
</ul></li>
<li><p>Why prefer covariate patterns approach?</p>
<ul>
<li>When the number of covariate pattern is much smaller than n, there is risk that we may fail to identify influential and/or poorly fit covariate patterns using individual based on residual</li>
</ul></li>
</ul>
</section>
<section id="diagnostic-statistics-computation-22" class="level2">
<h2 class="anchored" data-anchor-id="diagnostic-statistics-computation-22">Diagnostic Statistics Computation (2/2)</h2>
<p>Consider a covariate pattern with <span class="math inline">\(m_j\)</span> subjects, all did not have event (some <span class="math inline">\(y_i = 0\)</span>). So the estimated logistic probability is <span class="math inline">\(\widehat\pi_j\)</span></p>
<ul>
<li><p>Pearson residual computed by individual <span class="math display">\[r_i=-\sqrt{\frac{{\hat{\pi}}_j}{(1-{\hat{\pi}}_j)}}\]</span></p></li>
<li><p>Pearson residual computed by covariate pattern <span class="math display">\[r_i=-\sqrt{m_j}\sqrt{\frac{{\hat{\pi}}_j}{(1-{\hat{\pi}}_j)}}\]</span></p></li>
<li><p><strong>Difference between aboveresiduals will be large if <span class="math inline">\(m_j\)</span> is large</strong>: usually a problem if less covariate patterns</p>
<ul>
<li>Residual from covariate pattern will identify poorly fit covariate patterns</li>
</ul></li>
</ul>
</section>
<section id="diagnostics-of-logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="diagnostics-of-logistic-regression">Diagnostics of Logistic Regression</h2>
<ul>
<li><p>Model diagnostics of logistic regression can be assessed by checking how influential a covariate pattern is:</p>
<p>&nbsp;</p>
<ul>
<li><p>Look at <span style="color:#70AD47">change in residuals if a covariate pattern is excluded</span></p>
<ul>
<li>Standardized Pearson residual</li>
<li>Standardized Deviance residual</li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Look at <span style="color:#5B9BD5">change in coefficients if a covariate pattern is excluded</span></li>
</ul></li>
</ul>
</section>
<section id="change-of-standardized-residuals" class="level2">
<h2 class="anchored" data-anchor-id="change-of-standardized-residuals">Change of Standardized Residuals</h2>
<ul>
<li><p>Change in <strong>standardized Pearson Chi-square statistic</strong> due to deletion of subjects with covariate pattern <span class="math inline">\(x_j\)</span>: <span class="math display">\[\Delta X_j^2 = r_{sj}^2 = \dfrac{r_j^2}{1-h_j}\]</span></p></li>
<li><p><em>Don‚Äôt need to know this</em>: change in <strong>standardized deviance statistic</strong> due to deletion of subjects with covariate pattern <span class="math inline">\(x_j\)</span>: <span class="math display">\[\Delta D_j = \dfrac{d_j^2}{1-h_j}\]</span></p></li>
<li><p>Refer to <em>Lesson 12: Assessing Model Fit</em> for expression of Pearson residual</p></li>
</ul>
</section>
<section id="change-of-estimated-coefficients" class="level2">
<h2 class="anchored" data-anchor-id="change-of-estimated-coefficients">Change of Estimated Coefficients</h2>
<ul>
<li>Change in estimated coefficients due to deletion of subjects with covariate pattern <span class="math inline">\(x_j\)</span>: <span class="math display">\[\Delta \widehat{\beta}_j = \dfrac{r_j^2 h_j}{(1-h_j)^2}\]</span></li>
</ul>
<p>&nbsp;</p>
<ul>
<li>This is the logistic regression analog of Cook‚Äôs influence statistic (in linear regression)</li>
</ul>
</section>
</section>
<section id="minute-break" class="level1">
<h1>10 minute break</h1>
</section>
<section id="learning-objectives-2" class="level1">
<h1>Learning Objectives</h1>
<ol type="1">
<li>Understand the components of calculations for logistic regression diagnostics</li>
</ol>
<div class="lob">
<ol start="2" type="1">
<li>Plot and determine observations where regression does not fit well or are influential using specific diagnostic values</li>
</ol>
</div>
<section id="visual-assessment-for-diagnostics-of-logistic-regression-i" class="level2">
<h2 class="anchored" data-anchor-id="visual-assessment-for-diagnostics-of-logistic-regression-i">Visual Assessment for Diagnostics of Logistic Regression (I)</h2>
<ul>
<li><p>In logistic regression, we mainly rely on graphical methods</p>
<ul>
<li>Because the distribution of diagnostic measures under null hypothesis (that the model fits) is only known in certain limited settings</li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>Four plots for analysis of diagnostics in logistic regression:</p>
<ul>
<li><span class="math inline">\(\Delta X_j^2\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
<li><span class="math inline">\(\Delta D_j\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
<li><span class="math inline">\(\Delta\widehat{\beta}_j\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
<li><span class="math inline">\(h_j\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
</ul></li>
</ul>
</section>
<section id="recall-the-model-we-fit-glow-study-with-interactions" class="level2">
<h2 class="anchored" data-anchor-id="recall-the-model-we-fit-glow-study-with-interactions">Recall the model we fit: GLOW Study with interactions</h2>
<ul>
<li><p><strong>Outcome variable:</strong> any fracture in the first year of follow up (FRACTURE: 0 or 1)</p></li>
<li><p><strong>Risk factor/variable of interest:</strong> history of prior fracture (PRIORFRAC: 0 or 1)</p></li>
<li><p><strong>Potential confounder or effect modifier:</strong> age (AGE, a continuous variable)</p></li>
<li><p>Fitted model with interactions: <span class="math display">\[\begin{aligned} \text{logit}\left(\widehat\pi(\mathbf{X})\right) &amp; = \widehat\beta_0 &amp;+ &amp;\widehat\beta_1\cdot I(\text{PF}) &amp; + &amp;\widehat\beta_2\cdot Age&amp; + &amp;\widehat\beta_3 \cdot I(\text{PF}) \cdot Age \\  
\text{logit}\left(\widehat\pi(\mathbf{X})\right) &amp; = -1.376 &amp;+ &amp;1.002\cdot I(\text{PF})&amp; + &amp;0.063\cdot Age&amp; -&amp;0.057 \cdot I(\text{PF}) \cdot Age
\end{aligned}\]</span></p></li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Lesson 12: determined the overall fit of this model</li>
<li>Today: determine the if any observations/covariate patterns that model does not fit well</li>
</ul>
</section>
<section id="how-do-we-get-these-values-in-r" class="level2">
<h2 class="anchored" data-anchor-id="how-do-we-get-these-values-in-r">How do we get these values in R?</h2>
<ul>
<li><p>Nice function in the R script <code>Logistic_Dx_Functions.R</code></p>
<ul>
<li>Highly suggest you save this R script for future use!!</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"lectures"</span>, <span class="st">"14_Model_diagnostics"</span>, <span class="st">"Logistic_Dx_Functions.R"</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>dx_glow <span class="ot">=</span> <span class="fu">dx</span>(glow_m3)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dx_glow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 71
Columns: 16
$ `(Intercept)`        &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1‚Ä¶
$ priorfracYes         &lt;dbl&gt; 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0‚Ä¶
$ age_c                &lt;dbl&gt; 1, -7, 7, -2, 10, 20, 1, -2, 2, 8, 18, -8, 11, 10‚Ä¶
$ `priorfracYes:age_c` &lt;dbl&gt; 1, 0, 7, 0, 10, 0, 0, -2, 2, 0, 0, 0, 0, 0, -3, 0‚Ä¶
$ y                    &lt;dbl&gt; 2, 2, 3, 2, 2, 1, 3, 3, 1, 5, 1, 3, 2, 1, 1, 4, 1‚Ä¶
$ P                    &lt;dbl&gt; 0.4088354, 0.1402159, 0.4162991, 0.1822879, 0.420‚Ä¶
$ n                    &lt;int&gt; 5, 15, 7, 10, 5, 2, 12, 8, 3, 15, 2, 18, 7, 4, 3,‚Ä¶
$ yhat                 &lt;dbl&gt; 2.0441770, 2.1032389, 2.9140936, 1.8228786, 2.100‚Ä¶
$ Pr                   &lt;dbl&gt; -0.04018670, -0.07677228, 0.06586860, 0.14507476,‚Ä¶
$ dr                   &lt;dbl&gt; -0.04023255, -0.07730975, 0.06577949, 0.14332786,‚Ä¶
$ h                    &lt;dbl&gt; 0.008844090, 0.003811004, 0.008725450, 0.00290085‚Ä¶
$ sPr                  &lt;dbl&gt; -0.04036559, -0.07691899, 0.06615786, 0.14528564,‚Ä¶
$ sdr                  &lt;dbl&gt; -0.04041165, -0.07745749, 0.06606836, 0.14353620,‚Ä¶
$ dChisq               &lt;dbl&gt; 0.001629381, 0.005916530, 0.004376863, 0.02110791‚Ä¶
$ dDev                 &lt;dbl&gt; 0.001633102, 0.005999662, 0.004365028, 0.02060264‚Ä¶
$ dBhat                &lt;dbl&gt; 1.453897e-05, 2.263418e-05, 3.852626e-05, 6.14091‚Ä¶</code></pre>
</div>
</div>
</section>
<section id="key-to-the-values" class="level2">
<h2 class="anchored" data-anchor-id="key-to-the-values">Key to the values</h2>
<div class="columns">
<div class="column">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(dx_glow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "(Intercept)"        "priorfracYes"       "age_c"             
 [4] "priorfracYes:age_c" "y"                  "P"                 
 [7] "n"                  "yhat"               "Pr"                
[10] "dr"                 "h"                  "sPr"               
[13] "sdr"                "dChisq"             "dDev"              
[16] "dBhat"             </code></pre>
</div>
</div>
</div><div class="column">
<p>For each covariate pattern (which is each row) ‚Ä¶</p>
<ul>
<li><code>y</code>: Number of events</li>
<li><code>P</code>: Estimated probability of events</li>
<li><code>n</code>: Number of observations</li>
<li><code>yhat</code>: Estimated number of events</li>
<li><code>Pr</code>: Pearson residual</li>
<li><code>dr</code>: Deviance</li>
<li><code>h</code>: leverage</li>
<li><code>sPr</code>: Standardized Pearson residual</li>
<li><code>sdr</code>: Standardized deviance</li>
<li><code>dChisq</code>: Change in standardized Pearson residual</li>
<li><code>dDev</code>: Change in standardized deviance</li>
<li><code>dBhat</code>: Change in coefficient estimates</li>
</ul>
</div>
</div>
</section>
<section id="poll-everywhere-question-3" class="level2">
<h2 class="anchored" data-anchor-id="poll-everywhere-question-3">Poll Everywhere Question 3</h2>
</section>
<section id="visual-assessment-for-diagnostics-of-logistic-regression" class="level2">
<h2 class="anchored" data-anchor-id="visual-assessment-for-diagnostics-of-logistic-regression">Visual Assessment for Diagnostics of Logistic Regression</h2>
<ul>
<li><p>The plots allow us to identify those covariate patterns that are‚Ä¶</p>
<ul>
<li><p>Poorly fit</p>
<ul>
<li>Large values of <span class="math inline">\(\Delta X_j^2\)</span> (and/or <span class="math inline">\(\Delta D_j\)</span> if we looked at those)</li>
</ul></li>
<li><p>Influential on estimated coefficients</p>
<ul>
<li>Large values of <span class="math inline">\(\Delta\widehat{\beta}_j\)</span></li>
</ul></li>
</ul></li>
<li><p>If you are interested to look at the contribution of leverage (‚Ñé_ùëó) to the values of the diagnostic statistic, you may also look at plots of:</p>
<ul>
<li><span class="math inline">\(\Delta X_j^2\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
<li><span class="math inline">\(\Delta D_j\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
<li><span class="math inline">\(\Delta\widehat{\beta}_j\)</span> vs.&nbsp;<span class="math inline">\({\hat{\pi}}_j\)</span></li>
</ul></li>
</ul>
</section>
<section id="glow-study-standardized-pearson-residuals" class="level2">
<h2 class="anchored" data-anchor-id="glow-study-standardized-pearson-residuals">GLOW study: standardized Pearson residuals</h2>
<div class="columns">
<div class="column">
<ul>
<li><p>Generally, the points that curve from top left to bottom right of plot correspond to covariate patterns with <span class="math inline">\(y_j = 1\)</span></p>
<ul>
<li>Opposite corresponds to <span class="math inline">\(y_j = 0\)</span></li>
</ul></li>
</ul>
</div><div class="column">
<div class="cell">
<details class="code-fold">
<summary>To make the plot</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dx_glow) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>P, <span class="at">y=</span>dChisq), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Estimated/Predicted Probability of Fracture"</span>) <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Change in Std. Pearson Residual"</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14_Model_diagnostics_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="glow-study-standardized-pearson-residuals-1" class="level2">
<h2 class="anchored" data-anchor-id="glow-study-standardized-pearson-residuals-1">GLOW study: standardized Pearson residuals</h2>
<div class="columns">
<div class="column">
<ul>
<li><p>Generally, the points that curve from top left to bottom right of plot correspond to covariate patterns with <span class="math inline">\(y_j = 1\)</span></p>
<ul>
<li>Opposite corresponds to <span class="math inline">\(y_j = 0\)</span></li>
</ul></li>
<li><p>Points in the top left or top right corners identify the covariate patterns that are poorly fit</p></li>
<li><p>We may use 4 as a crude approximation to the upper 95th percentile for <span class="math inline">\(\Delta X_j^2\)</span></p>
<ul>
<li>95th percentile of chi-squared distribution is 3.84</li>
</ul></li>
</ul>
</div><div class="column">
<div class="cell">
<details class="code-fold">
<summary>To make the plot</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dx_glow) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>P, <span class="at">y=</span>dChisq), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Estimated/Predicted Probability of Fracture"</span>) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Change in Std. Pearson Residual"</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14_Model_diagnostics_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="glow-study-standardized-pearson-residuals-2" class="level2">
<h2 class="anchored" data-anchor-id="glow-study-standardized-pearson-residuals-2">GLOW study: standardized Pearson residuals</h2>
<div class="columns">
<div class="column">
<ul>
<li><p>Generally, the points that curve from top left to bottom right of plot correspond to covariate patterns with <span class="math inline">\(y_j = 1\)</span></p>
<ul>
<li>Opposite corresponds to <span class="math inline">\(y_j = 0\)</span></li>
</ul></li>
<li><p>Points in the top left or top right corners identify the covariate patterns that are poorly fit</p></li>
<li><p>We may use 4 as a crude approximation to the upper 95th percentile for <span class="math inline">\(\Delta X_j^2\)</span></p>
<ul>
<li>95th percentile of chi-squared distribution is 3.84</li>
</ul></li>
<li><p>Which point is over 4?</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dx_glow <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dChisq <span class="sc">&gt;</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(priorfracYes, age_c, P, dChisq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   priorfracYes age_c         P   dChisq
          &lt;num&gt; &lt;num&gt;     &lt;num&gt;    &lt;num&gt;
1:            0    -4 0.1643855 4.413937</code></pre>
</div>
</div>
</div><div class="column">
<div class="cell">
<details class="code-fold">
<summary>To make the plot</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dx_glow) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>P, <span class="at">y=</span>dChisq), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Estimated/Predicted Probability of Fracture"</span>) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Change in Std. Pearson Residual"</span>) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14_Model_diagnostics_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="glow-study-standardized-deviance-residuals" class="level2">
<h2 class="anchored" data-anchor-id="glow-study-standardized-deviance-residuals">GLOW study: standardized Deviance residuals</h2>
<div class="columns">
<div class="column">
<ul>
<li><p>Same investigation as Pearson residuals</p></li>
<li><p>Points in the top left or top right corners identify the covariate patterns that are poorly fit</p></li>
<li><p>Use 4 as a crude approximation to the upper 95th percentile</p></li>
<li><p>Which point is over 4?</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dx_glow <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dDev <span class="sc">&gt;</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(priorfracYes, age_c, P, dDev)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   priorfracYes age_c         P     dDev
          &lt;num&gt; &lt;num&gt;     &lt;num&gt;    &lt;num&gt;
1:            0   -10 0.1190935 4.841217
2:            0     7 0.2812460 5.313540
3:            1     6 0.4150524 4.325664</code></pre>
</div>
</div>
</div><div class="column">
<div class="cell">
<details class="code-fold">
<summary>To make the plot</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dx_glow) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>P, <span class="at">y=</span>dDev), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Estimated/Predicted Probability of Fracture"</span>) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Change in Std. Deviance Residual"</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14_Model_diagnostics_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="glow-study-change-in-coefficient-estimates" class="level2">
<h2 class="anchored" data-anchor-id="glow-study-change-in-coefficient-estimates">GLOW Study: Change in coefficient estimates</h2>
<div class="columns">
<div class="column">
<ul>
<li><p>Book recommends flagging certain covariate patterns if change in coefficient estimates are greater than 1</p></li>
<li><p>All values of <span class="math inline">\(\Delta\widehat{\beta}_j\)</span> are below 0.09</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dx_glow <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dBhat <span class="sc">&gt;</span> <span class="fl">0.075</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(priorfracYes, age_c, P, dBhat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   priorfracYes age_c         P      dBhat
          &lt;num&gt; &lt;num&gt;     &lt;num&gt;      &lt;num&gt;
1:            1    20 0.4325984 0.08926472</code></pre>
</div>
</div>
</div><div class="column">
<div class="cell">
<details class="code-fold">
<summary>To make the plot</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dx_glow) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>P, <span class="at">y=</span>dBhat), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Estimated/Predicted Probability of Fracture"</span>) <span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Change in Coefficient Estimates"</span>) <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14_Model_diagnostics_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="glow-study-leverage" class="level2">
<h2 class="anchored" data-anchor-id="glow-study-leverage">GLOW Study: Leverage</h2>
<div class="columns">
<div class="column">
<ul>
<li><p>We can use the same rule as linear regression: <span class="math inline">\(h_j &gt; 3p/n\)</span></p>
<ul>
<li>Flag these points as high leverage</li>
</ul></li>
<li><p>Points with high leverage</p>
<ul>
<li><span class="math inline">\(p=4\)</span>: four regression coefficients</li>
<li><span class="math inline">\(n=500\)</span>: 500 total observations</li>
<li>Look for <span class="math inline">\(h_j &gt; 3p/n = 3\cdot4 /500 = 0.024\)</span></li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dx_glow <span class="sc">%&gt;%</span> <span class="fu">filter</span>(h <span class="sc">&gt;</span> <span class="dv">3</span><span class="sc">*</span><span class="dv">4</span><span class="sc">/</span><span class="dv">500</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(priorfracYes, age_c, P, h) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   priorfracYes age_c         P          h
          &lt;num&gt; &lt;num&gt;     &lt;num&gt;      &lt;num&gt;
1:            0    20 0.4686423 0.02688958
2:            1   -12 0.3928116 0.03186122
3:            0    19 0.4531105 0.02451738
4:            1   -11 0.3940365 0.02900675
5:            1    19 0.4313389 0.02895824
6:            1    18 0.4300804 0.02621708</code></pre>
</div>
</div>
</div><div class="column">
<div class="cell">
<details class="code-fold">
<summary>To make the plot</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dx_glow) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x=</span>P, <span class="at">y=</span>h), <span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Estimated/Predicted Probability of Fracture"</span>) <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Leverage"</span>) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">26</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14_Model_diagnostics_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="find-out-the-influential-observation-from-the-data-set" class="level2">
<h2 class="anchored" data-anchor-id="find-out-the-influential-observation-from-the-data-set">Find Out the ‚ÄúInfluential‚Äù Observation From the Data Set</h2>
<div class="columns">
<div class="column" style="width:30%;">
<ul>
<li>We identified covariate patterns that may be poorly fit or influential</li>
</ul>
<p>&nbsp;</p>
<ul>
<li>Let‚Äôs identify the covariate patterns that were not fit well</li>
</ul>
</div><div class="column" style="width:70%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dx_glow <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Cov_patt =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dChisq <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">|</span> dDev <span class="sc">&gt;</span> <span class="dv">4</span> <span class="sc">|</span> dBhat <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">|</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>          h <span class="sc">&gt;</span> <span class="dv">3</span><span class="sc">*</span><span class="dv">4</span><span class="sc">/</span><span class="dv">500</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Cov_patt, y, P, h, dChisq, dDev, dBhat, h) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(., <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Cov_patt     y     P     h dChisq  dDev dBhat
       &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt; &lt;num&gt; &lt;num&gt;
 1:        6     1 0.469 0.027  0.008 0.008 0.000
 2:       22     1 0.393 0.032  0.046 0.047 0.002
 3:       36     1 0.453 0.025  0.178 0.183 0.004
 4:       43     0 0.119 0.005  2.581 4.841 0.012
 5:       45     6 0.164 0.003  4.414 3.554 0.014
 6:       47     0 0.281 0.006  3.148 5.314 0.018
 7:       48     0 0.394 0.029  0.670 1.032 0.020
 8:       49     2 0.431 0.029  0.698 0.693 0.021
 9:       50     0 0.430 0.026  0.775 1.155 0.021
10:       53     0 0.415 0.008  2.862 4.326 0.024
11:       57     2 0.395 0.026  0.949 0.924 0.026
12:       63     0 0.484 0.029  0.967 1.364 0.029
13:       69     0 0.434 0.035  1.588 2.358 0.058
14:       70     1 0.392 0.035  1.610 1.943 0.058
15:       71     2 0.433 0.032  2.710 3.462 0.089</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="after-identifying-points" class="level2">
<h2 class="anchored" data-anchor-id="after-identifying-points">After identifying points</h2>
<ul>
<li><p>Do a data quality check</p>
<ul>
<li>Unless you have a very good reason to believe the data are not measured correctly, then we leave it in</li>
<li>Common to do nothing</li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>If only a few covariate pattern does not fit well (<span class="math inline">\(y_j\)</span> differs from <span class="math inline">\(m_j\widehat\pi_j\)</span> ), we are not too worried</p>
<ul>
<li>We had 15 out of 71 covariate patterns</li>
</ul></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><p>If quite a few covariate patterns do not fit well, potential reasons can be considered:</p>
<ul>
<li><p>The link used in logistic regression model is not appropriate for outcome</p>
<ul>
<li>This is usually unlikely, since logistic regression model is very flexible (think back to why we transformed our outcome from binary form)</li>
</ul></li>
<li><p>One or more important covariates missing in the model</p>
<ul>
<li>At least one of the covariates in the model has been entered in the wrong scale (think age-squared vs.&nbsp;age)</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="how-would-i-report-this-combining-all-model-assessment" class="level2">
<h2 class="anchored" data-anchor-id="how-would-i-report-this-combining-all-model-assessment">How would I report this? (Combining all model assessment)</h2>
<ul>
<li>Assuming I have not checked other final models (no other models to compare AIC/BIC or AUC with)</li>
</ul>
<p><strong>Methods:</strong> To assess the overall model fit, we calculated the AUC-ROC. We also calculated several model diagnostics including standardized Pearson residual, standardized deviance, change in coefficient estimates, and leverage. We identified covariate patterns with high standardized Pearson residual (greater than 4), standardized deviance (greater than 4), change in coefficient estimates (greater than 1), and leverage (greater than 0.024).</p>
<p>&nbsp;</p>
<p><strong>Results:</strong> Our final logistic regression model consisted of the outcome, fracture, and predictors including prior fracture, age, and their interaction. The AUC-ROC was 0.68. We identified 11 covariate patterns with high leverage and 4 with high standardized Pearson residual, standardized deviance, or change in coefficient estimates. No identified observations were omitted.</p>
<p>&nbsp;</p>
<p><strong>Discussion:</strong></p>
<ul>
<li><p>AUC-ROC low: Included covariates were pre-determined</p></li>
<li><p>Influential points were kept in because all observations were within feasible range of the predictors and outcome. (we could try age-sqaured and see if that helps AUC and/or diagnostics)</p></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>